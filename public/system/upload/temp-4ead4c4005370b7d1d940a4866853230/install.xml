<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Price replace options</name>
    <id>price_replace_options_ocmod</id>
    <version>v1 price_replace_options_ocmod</version>
    <author>ocextensions.co.uk for cancer research</author>
    <link>mailto:support@ocextensions.co.uk</link>
    <code>price_replace_options_ocmod</code>
    <file path="admin/view/template/catalog/product_form.tpl">
        <operation>
            <search index="0"><![CDATA[<option value="-">-</option>]]></search>
            <add position="after" offset="1"><![CDATA[                      <?php if ($product_option_value['price_prefix'] == '=') { ?>
                      <option value="=" selected="selected"> = </option>
                      <?php } else { ?>
                      <option value="="> = </option>
                      <?php } ?>]]></add>
        </operation> 
        <operation>
            <search index="0"><![CDATA[html += '    <option value="-">-</option>';]]></search>
            <add position="after"><![CDATA[        html += '      <option value="="> = </option>';]]></add>
        </operation> 
    </file> 
    <file path="system/library/cart.php">  
        <operation>
            <search><![CDATA[$option_price -= $option_value_query->row['price'];]]></search>
            <add position="after"><![CDATA[									} elseif ($option_value_query->row['price_prefix'] == '=') {
										$option_price += $option_value_query->row['price'] - $product_query->row['price'];]]></add>
        </operation>
    </file>
    <file path="catalog/controller/product/product.php">  
        <operation>
            <search><![CDATA[public function review() {]]></search>
            <add position="before"><![CDATA[public function add() {
		$this->load->language('checkout/cart');
            $hold = array();
		    $json = array();
		
		if (isset($this->request->post['product_id'])) {
			$product_id = $this->request->post['product_id'];
		} else {
			$product_id = 0;
		}
		
		$this->load->model('catalog/product');
						
		$product_info = $this->model_catalog_product->getProduct($product_id);
		
		if ($product_info) {
                            if (isset($this->request->post['quantity'])) {
				$quantity = $this->request->post['quantity'];
			} else {
		       $quantity = 1;								
			}
												
			if (isset($this->request->post['option'])) {
				$option = array_filter($this->request->post['option']);
			} else {
				$option = array();	
			}
			
			$product_options = $this->model_catalog_product->getProductOptions($this->request->post['product_id']);
                        
                    $hold = $this->session->data['cart'];  
                            
			if (!$json) {
                    $this->cart->clear();
				$this->cart->add($this->request->post['product_id'], $this->request->post['quantity'], $option);
                
                    $this->data = array();
      			
				$json['success'] = '0';
                                
                unset($this->session->data['shipping_method']);
				unset($this->session->data['shipping_methods']);
				unset($this->session->data['payment_method']);
				unset($this->session->data['payment_methods']);
                                
				// Totals
				$this->load->model('extension/extension');
				
				$total_data = array();					
				$total = 0;
				$taxes = $this->cart->getTaxes();
				
				// Display prices
				if (($this->config->get('config_customer_price') && $this->customer->isLogged()) || !$this->config->get('config_customer_price')) {
					$sort_order = array(); 
					
					$results = $this->model_extension_extension->getExtensions('total');
					
					foreach ($results as $key => $value) {
						$sort_order[$key] = $this->config->get($value['code'] . '_sort_order');
					}
					
					array_multisort($sort_order, SORT_ASC, $results);
					
                            
					foreach ($results as $result) {
						if ($this->config->get($result['code'] . '_status')) {
							$this->load->model('total/' . $result['code']);
				
							$this->{'model_total_' . $result['code']}->getTotal($total_data, $total, $taxes);
						}
						
						$sort_order = array(); 
					  
						foreach ($total_data as $key => $value) {
							$sort_order[$key] = $value['sort_order'];
						}
			
						array_multisort($sort_order, SORT_ASC, $total_data);			
					}
				}
		
          if ($this->config->get('config_tax') == '0') {    
                                          $val = array_sum($taxes);
                                        $total = $total - $val;
                                }   
                  $this->session->data['cart'] = $hold;  
				$json['total'] = sprintf($this->currency->format($total));
                                          $tax = $total - array_sum($taxes);
                                  $json['tax'] =  sprintf($this->currency->format($tax));
			        } else {
			     $json['redirect'] = str_replace('&amp;', '&', $this->url->link('product/product', 'product_id=' . $this->request->post['product_id']));
			}
		}
		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));	
	}
	]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/*/template/product/product.tpl">
        <operation>
            <search index='0,1,2,3'><![CDATA[<div class="form-group<?php echo ($option['required'] ? ' required' : ''); ?>">]]></search>
            <add position="replace"><![CDATA[<div class="option form-group<?php echo ($option['required'] ? ' required' : ''); ?>">]]></add>
        </operation> 
        <operation>
            <search><![CDATA[<h2><?php echo $special; ?></h2>]]></search>
            <add position="replace"><![CDATA[<h2 class="opprice"><?php echo $special; ?></h2>]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[<?php echo $text_tax; ?> <?php echo $tax; ?>]]></search>
            <add position="replace"><![CDATA[<?php echo $text_tax; ?> <div class="price-tax"><?php echo $tax; ?></div>]]></add>
        </operation>    
        <operation>
            <search><![CDATA[(<?php echo $option_value['price_prefix'];]]></search>
            <add position="before"><![CDATA[                  <?php  if ($option_value['price_prefix'] != '=') {?>]]></add>
        </operation>  
        <operation>
            <search><![CDATA[(<?php echo $option_value['price_prefix'];]]></search>
            <add position="after"><![CDATA[                    <?php } else { ?> : <?php echo $option_value['price']; }?>]]></add>
        </operation>  
        <operation>
            <search><![CDATA[<input type="text" name="quantity" ]]></search>
            <add position="replace"><![CDATA[               <input id='bc' type="text" name="quantity" ]]>
            </add>
        </operation> 
        <operation>
            <search index='0'><![CDATA[<?php echo $price; ?>]]></search>
            <add position="replace"><![CDATA[         <div class="opprice"><?php echo $price; ?></div>
                                            ]]>
            </add>
        </operation>
        <operation>
            <search><![CDATA[<?php echo $footer; ?>]]></search>
            <add position="before"><![CDATA[<script type="text/javascript"><!--
function a(){ 
	$.ajax({
		url: 'index.php?route=product/product/add',
		type: 'post',
        data: $(":input").serializeArray(),
		dataType: 'json',
		success: function(json) {
			$('.success, .warning, .attention, information, .error').remove();
			if (json['error']) {
				if (json['error']['option']) {
					for (i in json['error']['option']) {
						$('#option-' + i).after('<span class="error">' + json['error']['option'][i] + '</span>');
					}
				}
			} 
			if (json['success']) {
				$('.opprice').html (json['total']);
                                $('.price-tax').html (json['tax']);
		                          }
	    }
	});
} 
$(document).on("change", ".option", a);
$(document).on("keyup", "#bc", a);    
//--></script>
]]>
            </add>
        </operation>
    </file> 
</modification>
      
